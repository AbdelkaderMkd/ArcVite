import{pP as re,ie as se,bt as G,bw as j,ir as k,ii as N,c as oe,iq as le,u as ue,pQ as W,ij as b,pR as fe,pS as A,pT as X,pU as K,im as ce}from"./index-80114339.js";import{e as V,a as te,r as J}from"./definitions-e92533c5.js";import{T as z}from"./enums-b1d611e3.js";import{M as H}from"./number-e491b09e.js";import{c as Z}from"./GeometryUtils-dd03fc25.js";class Y{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(n,e){}draw(n,e,t){}drawMany(n,e,t){for(const l of e)l.visible&&this.draw(n,l,t)}}let Me=class extends Y{constructor(){super(...arguments),this._color=re(1,0,0,1),this._patternMatrix=se(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(n,e){const{context:t,painter:l,styleLayerUID:o,requestRender:a,allowDelayedRender:U}=n;this._loadWGLResources(n);const _=n.displayLevel,u=n.styleLayer,v=u.backgroundMaterial,y=l.vectorTilesMaterialManager,P=u.getPaintValue("background-color",_),m=u.getPaintValue("background-opacity",_),S=u.getPaintValue("background-pattern",_),D=S!==void 0,E=P[3]*m,I=1|window.devicePixelRatio,h=n.spriteMosaic;let x,T;const f=I>te?2:1,d=n.drawPhase===z.HITTEST,p=this._programOptions;p.id=d,p.pattern=D;const r=y.getMaterialProgram(t,v,p);if(!U||a==null||r.compiled){if(t.bindVAO(this._vao),t.useProgram(r),D){const s=h.getMosaicItemPosition(S,!0);if(s!=null){const{tl:c,br:i,page:M}=s;x=i[0]-c[0],T=i[1]-c[1];const g=h.getPageSize(M);g!=null&&(h.bind(t,G.LINEAR,M,V),r.setUniform4f("u_tlbr",c[0],c[1],i[0],i[1]),r.setUniform2fv("u_mosaicSize",g),r.setUniform1i("u_texture",V))}r.setUniform1f("u_opacity",m)}else this._color[0]=E*P[0],this._color[1]=E*P[1],this._color[2]=E*P[2],this._color[3]=E,r.setUniform4fv("u_color",this._color);if(r.setUniform1f("u_depth",u.z||0),d){const s=H(o+1);r.setUniform4fv("u_id",s)}for(const s of e){if(r.setUniform1f("u_coord_range",s.rangeX),r.setUniformMatrix3fv("u_dvsMat3",s.transforms.dvs),D){const c=Math.max(2**(Math.round(_)-s.key.level),1),i=f*s.width*c,M=i/j(x),g=i/j(T);this._patternMatrix[0]=M,this._patternMatrix[4]=g,r.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}t.setStencilFunction(k.EQUAL,0,255),t.drawArrays(N.TRIANGLE_STRIP,0,4)}}else a()}_loadWGLResources(n){if(this._vao)return;const{context:e,styleLayer:t}=n,l=t.backgroundMaterial,o=new Int8Array([0,0,1,0,0,1,1,1]),a=oe.createVertex(e,le.STATIC_DRAW,o),U=new ue(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:a});this._vao=U}};class Ue extends Y{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(n,e){const{context:t,displayLevel:l,requiredLevel:o,state:a,drawPhase:U,painter:_,spriteMosaic:u,styleLayerUID:v,requestRender:y,allowDelayedRender:P}=n;if(!e.some(p=>{var r;return((r=p.layerData.get(v))==null?void 0:r.circleIndexCount)??!1}))return;const m=n.styleLayer,S=m.circleMaterial,D=_.vectorTilesMaterialManager,E=1.2,I=m.getPaintValue("circle-translate",l),h=m.getPaintValue("circle-translate-anchor",l),x=U===z.HITTEST,T=this._programOptions;T.id=x;const f=D.getMaterialProgram(t,S,T);if(P&&y!=null&&!f.compiled)return void y();t.useProgram(f),f.setUniformMatrix3fv("u_displayMat3",h===W.VIEWPORT?a.displayMat3:a.displayViewMat3),f.setUniform2fv("u_circleTranslation",I),f.setUniform1f("u_depth",m.z),f.setUniform1f("u_antialiasingWidth",E);let d=-1;if(x){const p=H(v+1);f.setUniform4fv("u_id",p)}for(const p of e){if(!p.layerData.has(v))continue;p.key.level!==d&&(d=p.key.level,S.setDataUniforms(f,l,m,d,u));const r=p.layerData.get(v);if(!r.circleIndexCount)continue;r.prepareForRendering(t);const s=r.vao;s!=null&&(t.bindVAO(s),f.setUniformMatrix3fv("u_dvsMat3",p.transforms.dvs),o!==p.key.level?t.setStencilFunction(k.EQUAL,p.stencilRef,255):t.setStencilFunction(k.GREATER,255,255),t.drawElements(N.TRIANGLES,r.circleIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r.circleIndexStart),p.triangleCount+=r.circleIndexCount/3)}}}const ee=1/65536;class he extends Y{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(n,e){const{displayLevel:t,drawPhase:l,renderPass:o,spriteMosaic:a,styleLayerUID:U}=n;let _=!1;for(const f of e)if(f.layerData.has(U)){const d=f.layerData.get(U);if(d.fillIndexCount>0||d.outlineIndexCount>0){_=!0;break}}if(!_)return;const u=n.styleLayer,v=u.getPaintProperty("fill-pattern"),y=v!==void 0,P=y&&v.isDataDriven;let m;if(y&&!P){const f=v.getValue(t);m=a.getMosaicItemPosition(f,!0)}const S=!y&&u.getPaintValue("fill-antialias",t);let D=!0,E=1;if(!y){const f=u.getPaintProperty("fill-color"),d=u.getPaintProperty("fill-opacity");if(!(f!=null&&f.isDataDriven)&&!(d!=null&&d.isDataDriven)){const p=u.getPaintValue("fill-color",t);E=u.getPaintValue("fill-opacity",t)*p[3],E>=1&&(D=!1)}}if(D&&o==="opaque")return;let I;l===z.HITTEST&&(I=H(U+1));const h=u.getPaintValue("fill-translate",t),x=u.getPaintValue("fill-translate-anchor",t);(D||o!=="translucent")&&this._drawFill(n,U,u,e,h,x,y,m,P,I);const T=!u.hasDataDrivenOutlineColor&&u.outlineUsesFillColor&&E<1;S&&o!=="opaque"&&!T&&this._drawOutline(n,U,u,e,h,x,I)}_drawFill(n,e,t,l,o,a,U,_,u,v){if(U&&!u&&_==null)return;const{context:y,displayLevel:P,state:m,drawPhase:S,painter:D,pixelRatio:E,spriteMosaic:I,requestRender:h,allowDelayedRender:x}=n,T=t.fillMaterial,f=D.vectorTilesMaterialManager,d=E>te?2:1,p=S===z.HITTEST,r=this._fillProgramOptions;r.id=p,r.pattern=U;const s=f.getMaterialProgram(y,T,r);if(x&&h!=null&&!s.compiled)return void h();if(y.useProgram(s),_!=null){const{page:i}=_,M=I.getPageSize(i);M!=null&&(I.bind(y,G.LINEAR,i,V),s.setUniform2fv("u_mosaicSize",M),s.setUniform1i("u_texture",V))}s.setUniformMatrix3fv("u_displayMat3",a===W.VIEWPORT?m.displayMat3:m.displayViewMat3),s.setUniform2fv("u_fillTranslation",o),s.setUniform1f("u_depth",t.z+ee),p&&s.setUniform4fv("u_id",v);let c=-1;for(const i of l){if(!i.layerData.has(e))continue;i.key.level!==c&&(c=i.key.level,T.setDataUniforms(s,P,t,c,I));const M=i.layerData.get(e);if(!M.fillIndexCount)continue;M.prepareForRendering(y);const g=M.fillVAO;if(g!=null){if(y.bindVAO(g),s.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),y.setStencilFunction(k.EQUAL,i.stencilRef,255),U){const w=Math.max(2**(Math.round(P)-i.key.level),1),L=i.rangeX/(d*i.width*w);s.setUniform1f("u_patternFactor",L)}if(u){const w=M.patternMap;if(!w)continue;for(const[L,$]of w){const C=I.getPageSize(L);C!=null&&(I.bind(y,G.LINEAR,L,V),s.setUniform2fv("u_mosaicSize",C),s.setUniform1i("u_texture",V),y.drawElements(N.TRIANGLES,$[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*$[0]))}}else y.drawElements(N.TRIANGLES,M.fillIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*M.fillIndexStart);i.triangleCount+=M.fillIndexCount/3}}}_drawOutline(n,e,t,l,o,a,U){const{context:_,displayLevel:u,state:v,drawPhase:y,painter:P,pixelRatio:m,spriteMosaic:S,requestRender:D,allowDelayedRender:E}=n,I=t.outlineMaterial,h=P.vectorTilesMaterialManager,x=.75/m,T=y===z.HITTEST,f=this._outlineProgramOptions;f.id=T;const d=h.getMaterialProgram(_,I,f);if(E&&D!=null&&!d.compiled)return void D();_.useProgram(d),d.setUniformMatrix3fv("u_displayMat3",a===W.VIEWPORT?v.displayMat3:v.displayViewMat3),d.setUniform2fv("u_fillTranslation",o),d.setUniform1f("u_depth",t.z+ee),d.setUniform1f("u_outline_width",x),T&&d.setUniform4fv("u_id",U);let p=-1;for(const r of l){if(!r.layerData.has(e))continue;r.key.level!==p&&(p=r.key.level,I.setDataUniforms(d,u,t,p,S));const s=r.layerData.get(e);if(s.prepareForRendering(_),!s.outlineIndexCount)continue;const c=s.outlineVAO;c!=null&&(_.bindVAO(c),d.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),_.setStencilFunction(k.EQUAL,r.stencilRef,255),_.drawElements(N.TRIANGLES,s.outlineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.outlineIndexStart),r.triangleCount+=s.outlineIndexCount/3)}}}class ve extends Y{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(n,e){const{context:t,displayLevel:l,state:o,drawPhase:a,painter:U,pixelRatio:_,spriteMosaic:u,styleLayerUID:v,requestRender:y,allowDelayedRender:P}=n;if(!e.some(g=>{var w;return((w=g.layerData.get(v))==null?void 0:w.lineIndexCount)??!1}))return;const m=n.styleLayer,S=m.lineMaterial,D=U.vectorTilesMaterialManager,E=m.getPaintValue("line-translate",l),I=m.getPaintValue("line-translate-anchor",l),h=m.getPaintProperty("line-pattern"),x=h!==void 0,T=x&&h.isDataDriven;let f,d;if(x&&!T){const g=h.getValue(l);f=u.getMosaicItemPosition(g)}let p=!1;if(!x){const g=m.getPaintProperty("line-dasharray");if(d=g!==void 0,p=d&&g.isDataDriven,d&&!p){const w=g.getValue(l),L=m.getDashKey(w,m.getLayoutValue("line-cap",l));f=u.getMosaicItemPosition(L)}}const r=1/_,s=a===z.HITTEST,c=this._programOptions;c.id=s,c.pattern=x,c.sdf=d;const i=D.getMaterialProgram(t,S,c);if(P&&y!=null&&!i.compiled)return void y();if(t.useProgram(i),i.setUniformMatrix3fv("u_displayViewMat3",o.displayViewMat3),i.setUniformMatrix3fv("u_displayMat3",I===W.VIEWPORT?o.displayMat3:o.displayViewMat3),i.setUniform2fv("u_lineTranslation",E),i.setUniform1f("u_depth",m.z),i.setUniform1f("u_antialiasing",r),s){const g=H(v+1);i.setUniform4fv("u_id",g)}if(f&&f!=null){const{page:g}=f,w=u.getPageSize(g);w!=null&&(u.bind(t,G.LINEAR,g,V),i.setUniform2fv("u_mosaicSize",w),i.setUniform1i("u_texture",V))}let M=-1;for(const g of e){if(!g.layerData.has(v))continue;g.key.level!==M&&(M=g.key.level,S.setDataUniforms(i,l,m,M,u));const w=2**(l-M)/_;i.setUniform1f("u_zoomFactor",w);const L=g.layerData.get(v);if(!L.lineIndexCount)continue;L.prepareForRendering(t);const $=L.vao;if($!=null){if(t.bindVAO($),i.setUniformMatrix3fv("u_dvsMat3",g.transforms.dvs),t.setStencilFunction(k.EQUAL,g.stencilRef,255),T||p){const C=L.patternMap;if(!C)continue;for(const[B,R]of C){const F=u.getPageSize(B);F!=null&&(u.bind(t,G.LINEAR,B,V),i.setUniform2fv("u_mosaicSize",F),i.setUniform1i("u_texture",V),t.drawElements(N.TRIANGLES,R[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*R[0]))}}else t.drawElements(N.TRIANGLES,L.lineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*L.lineIndexStart);g.triangleCount+=L.lineIndexCount/3}}}}const de=1/65536;class Pe extends Y{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=fe()}dispose(){}drawMany(n,e){const{drawPhase:t,styleLayerUID:l}=n,o=n.styleLayer;let a;t===z.HITTEST&&(a=H(l+1)),this._drawIcons(n,o,e,a),this._drawText(n,o,e,a)}_drawIcons(n,e,t,l){const{context:o,displayLevel:a,drawPhase:U,painter:_,spriteMosaic:u,state:v,styleLayerUID:y,requestRender:P,allowDelayedRender:m}=n,S=e.iconMaterial,D=_.vectorTilesMaterialManager;let E,I=!1;for(const M of t)if(M.layerData.has(y)&&(E=M.layerData.get(y),E.iconPerPageElementsMap.size>0)){I=!0;break}if(!I)return;const h=e.getPaintValue("icon-translate",a),x=e.getPaintValue("icon-translate-anchor",a);let T=e.getLayoutValue("icon-rotation-alignment",a);T===A.AUTO&&(T=e.getLayoutValue("symbol-placement",a)===X.POINT?A.VIEWPORT:A.MAP);const f=T===A.MAP,d=e.getLayoutValue("icon-keep-upright",a)&&f,p=E.isIconSDF,r=U===z.HITTEST,s=this._iconProgramOptions;s.id=r,s.sdf=p;const c=D.getMaterialProgram(o,S,s);if(m&&P!=null&&!c.compiled)return void P();o.useProgram(c),c.setUniformMatrix3fv("u_displayViewMat3",T===A.MAP?v.displayViewMat3:v.displayMat3),c.setUniformMatrix3fv("u_displayMat3",x===W.VIEWPORT?v.displayMat3:v.displayViewMat3),c.setUniform2fv("u_iconTranslation",h),c.setUniform1f("u_depth",e.z),c.setUniform1f("u_mapRotation",Z(v.rotation)),c.setUniform1f("u_keepUpright",d?1:0),c.setUniform1f("u_level",10*a),c.setUniform1i("u_texture",V),c.setUniform1f("u_fadeDuration",K/1e3),r&&c.setUniform4fv("u_id",l);let i=-1;for(const M of t){if(!M.layerData.has(y)||(M.key.level!==i&&(i=M.key.level,S.setDataUniforms(c,a,e,i,u)),E=M.layerData.get(y),E.iconPerPageElementsMap.size===0))continue;E.prepareForRendering(o),E.updateOpacityInfo();const g=E.iconVAO;if(g!=null){o.bindVAO(g),c.setUniformMatrix3fv("u_dvsMat3",M.transforms.dvs),c.setUniform1f("u_time",(performance.now()-E.lastOpacityUpdate)/1e3);for(const[w,L]of E.iconPerPageElementsMap)this._renderIconRange(n,c,L,w,M)}}}_renderIconRange(n,e,t,l,o){const{context:a,spriteMosaic:U}=n;this._spritesTextureSize[0]=U.getWidth(l)/4,this._spritesTextureSize[1]=U.getHeight(l)/4,e.setUniform2fv("u_mosaicSize",this._spritesTextureSize),U.bind(a,G.LINEAR,l,V),a.setStencilTestEnabled(!0),a.setStencilFunction(k.GREATER,255,255),a.setStencilWriteMask(0),a.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3}_drawText(n,e,t,l){const{context:o,displayLevel:a,drawPhase:U,glyphMosaic:_,painter:u,pixelRatio:v,spriteMosaic:y,state:P,styleLayerUID:m,requestRender:S,allowDelayedRender:D}=n,E=e.textMaterial,I=u.vectorTilesMaterialManager;let h,x=!1;for(const O of t)if(O.layerData.has(m)&&(h=O.layerData.get(m),h.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const T=e.getPaintProperty("text-opacity");if(T&&!T.isDataDriven&&T.getValue(a)===0)return;const f=e.getPaintProperty("text-color"),d=!f||f.isDataDriven||f.getValue(a)[3]>0,p=e.getPaintProperty("text-halo-width"),r=e.getPaintProperty("text-halo-color"),s=(!p||p.isDataDriven||p.getValue(a)>0)&&(!r||r.isDataDriven||r.getValue(a)[3]>0);if(!d&&!s)return;const c=24/8;let i=e.getLayoutValue("text-rotation-alignment",a);i===A.AUTO&&(i=e.getLayoutValue("symbol-placement",a)===X.POINT?A.VIEWPORT:A.MAP);const M=i===A.MAP,g=e.getLayoutValue("text-keep-upright",a)&&M,w=U===z.HITTEST,L=.8*c/v;this._glyphTextureSize||(this._glyphTextureSize=ce(_.width/4,_.height/4));const $=e.getPaintValue("text-translate",a),C=e.getPaintValue("text-translate-anchor",a),B=this._sdfProgramOptions;B.id=w;const R=I.getMaterialProgram(o,E,B);if(D&&S!=null&&!R.compiled)return void S();o.useProgram(R),R.setUniformMatrix3fv("u_displayViewMat3",i===A.MAP?P.displayViewMat3:P.displayMat3),R.setUniformMatrix3fv("u_displayMat3",C===W.VIEWPORT?P.displayMat3:P.displayViewMat3),R.setUniform2fv("u_textTranslation",$),R.setUniform1f("u_depth",e.z+de),R.setUniform2fv("u_mosaicSize",this._glyphTextureSize),R.setUniform1f("u_mapRotation",Z(P.rotation)),R.setUniform1f("u_keepUpright",g?1:0),R.setUniform1f("u_level",10*a),R.setUniform1i("u_texture",J),R.setUniform1f("u_antialiasingWidth",L),R.setUniform1f("u_fadeDuration",K/1e3),w&&R.setUniform4fv("u_id",l);let F=-1;for(const O of t){if(!O.layerData.has(m)||(O.key.level!==F&&(F=O.key.level,E.setDataUniforms(R,a,e,F,y)),h=O.layerData.get(m),h.glyphPerPageElementsMap.size===0))continue;h.prepareForRendering(o),h.updateOpacityInfo();const Q=h.textVAO;if(Q==null)continue;o.bindVAO(Q),R.setUniformMatrix3fv("u_dvsMat3",O.transforms.dvs),o.setStencilTestEnabled(!0),o.setStencilFunction(k.GREATER,255,255),o.setStencilWriteMask(0);const ae=(performance.now()-h.lastOpacityUpdate)/1e3;R.setUniform1f("u_time",ae),h.glyphPerPageElementsMap.forEach((ie,ne)=>{this._renderGlyphRange(o,ie,ne,_,R,s,d,O)})}}_renderGlyphRange(n,e,t,l,o,a,U,_){l.bind(n,G.LINEAR,t,J),a&&(o.setUniform1f("u_halo",1),n.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),_.triangleCount+=e[1]/3),U&&(o.setUniform1f("u_halo",0),n.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),_.triangleCount+=e[1]/3)}}export{Me as _,Pe as a,he as d,ve as f,Ue as o,Y as t};
