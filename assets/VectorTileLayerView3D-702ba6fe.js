import{pU as V,pV as L,pT as z,bs as A,ct as U,bF as F,p$ as W,si as j,sj as G,jB as O,pY as p,jN as Y,jC as b,bD as E,ay as Z,sk as K,sl as Q,eq as J,aR as X,b5 as ee,fp as te,aW as ie,aH as H,aC as g,aD as m,aF as se}from"./index-3572d442.js";import{i as le,e as ae,l as re,u as ne,t as oe}from"./TileInfoViewPOT-76ed8bcb.js";import{_ as he,d as ce,f as de,o as ue,a as ge}from"./WGLBrushVTLSymbol-4e301e2a.js";import{o as me}from"./VTLMaterialManager-fe495fb5.js";import{l as P}from"./StyleRepository-a2e50a74.js";import{n as pe}from"./LayerView3D-e03f69d7.js";import{o as ye}from"./TiledLayerView3D-ee2433cc.js";import{u as fe}from"./LayerView-e8e5ef51.js";import"./Rect-ea14f53a.js";import"./pbf-db891cc3.js";import"./rasterizingUtils-5eb53e8f.js";import"./vec4f32-0d1b2306.js";import"./definitions-f926d1a5.js";import"./enums-b1d611e3.js";import"./number-e491b09e.js";import"./GeometryUtils-dd03fc25.js";import"./ShaderCompiler-77d0dcb6.js";import"./programUtils-f035fe8a.js";import"./GeometryUtils-984e8446.js";class _e{constructor(e,t,s){this._scale=e,this._shift=t,this._levelShift=s}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),s=this._shift+t;return s?[e[0]-t,e[1]>>s,e[2]>>s]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let s=0,a=0;const l=this._shift+this.getLevelShift(e[0]);if(l){const i=(1<<l)-1,r=t/(this._scale*(1<<l-1));s=(e[2]&i)*r,a=(e[1]&i)*r}return[s,a]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}function ve(n){const e=[],t=new le(4096,e,()=>{const a=new z;return a.show=!1,a.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),a.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),a}),s=new ae(e,t,(a,l,i)=>new re(a,l,i,n.styleRepository,n.key.level,0),(a,l)=>{V(a,l,!1)},()=>0,a=>{const l=n.styleRepository.getStyleLayerByUID(a).getLayoutProperty("visibility");return!l||l.getValue()!==L.NONE});e.push(n),t.add(n),s.setScreenSize(512,512),s.continue(1/0)}class D extends ne{constructor(e,t,s,a){super(e,t,s),this._memCache=a,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new oe(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,s,a){const l=new A(e,t,s,0);let i=this._memCache.get(l.id);if(i!=null)return i.retain(),i;const r=await this._getVectorTileData(l);if(U(a),!this._layer)return null;if(i=this._memCache.get(l.id),i!=null)return i.retain(),i;const o=this._layer.tileInfo.getTileBounds(F(),l),d=this._tileInfoView.getTileResolution(e);return i=new W(l,d,o[0],o[3],512,512,this._styleRepository,this._memCache),r?(i.setData(r),i.retain(),this._memCache.put(l.id,i,i.memoryUsed,j)):i.setData(null),i.neededForCoverage=!0,i.transforms.tileUnitsToPixels=G(1/8,0,0,0,1/8,0,0,0,1),ve(i),i}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,a={signal:s.signal},l=this._getParsedVectorTileData(e,a).then(i=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),i)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,l),this._ongoingRequestToController.set(t,s),l}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(s=>this.parseTileData({key:e,data:s},t))}}const Ce={vtlBackground:he,vtlFill:ce,vtlLine:de,vtlCircle:ue,vtlSymbol:ge},_=1e-6;class B{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new me}dispose(){this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache=null),this._vtlMaterialManager=O(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,s){const a=s.layers;e.renderPass="translucent";for(let l=0;l<a.length;l++){const i=a[l];if(i.type!==p.SYMBOL)continue;const r=i.getLayoutProperty("visibility");if(r&&r.getValue()===L.NONE)continue;const o=e.displayLevel;i.minzoom!==void 0&&i.minzoom>o+_||i.maxzoom!==void 0&&i.maxzoom<=o-_||(e.styleLayerUID=i.uid,e.styleLayer=i,this._drawWithBrush(e,t,"vtlSymbol"))}}drawBackground(e,t,s){if(s.backgroundBucketIds.length===0)return;const{context:a,displayLevel:l,requiredLevel:i}=e;t.key.level=i,a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!1),e.renderPass="background",s.backgroundBucketIds.forEach(r=>{const o=s.getLayerById(r);if(o.type!==p.BACKGROUND)return;const d=o.getLayoutProperty("visibility");d&&d.getValue()===L.NONE||o.minzoom!==void 0&&o.minzoom>l+_||o.maxzoom!==void 0&&o.maxzoom<=l-_||(e.styleLayerUID=o.uid,e.styleLayer=o,this._drawWithBrush(e,t,"vtlBackground"))})}drawTile(e,t,s,a){const{context:l}=e,i=s.layers;l.setBlendingEnabled(!1),l.setDepthTestEnabled(!0),l.setDepthWriteEnabled(!0),l.setDepthFunction(Y.LEQUAL),e.renderPass="opaque";for(let r=i.length-1;r>=0;r--){const o=i[r];a!=null&&a!==o.type||this._renderStyleLayer(o,e,t,!1)}l.setDepthWriteEnabled(!1),l.setBlendingEnabled(!0),l.setBlendFunctionSeparate(b.ONE,b.ONE_MINUS_SRC_ALPHA,b.ONE,b.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let r=0;r<i.length;r++){const o=i[r];a!=null&&a!==o.type||this._renderStyleLayer(o,e,t,!1)}l.setDepthTestEnabled(!1),l.bindVAO()}_renderStyleLayer(e,t,s,a){if(!(a||e&&s.layerData.has(e.uid)))return;const l=e.getLayoutProperty("visibility");if(l&&l.getValue()===L.NONE)return;const{renderPass:i}=t;let r;switch(e.type){case p.BACKGROUND:if(i!=="background")return;r="vtlBackground";break;case p.FILL:if(i!=="opaque"&&t.renderPass!=="translucent")return;r="vtlFill";break;case p.LINE:if(i!=="translucent")return;r="vtlLine";break;case p.CIRCLE:if(i!=="translucent")return;r="vtlCircle";break;case p.SYMBOL:if(i!=="translucent")return;r="vtlSymbol"}const o=t.displayLevel;if(e.minzoom!==void 0&&e.minzoom>o+_||e.maxzoom!==void 0&&e.maxzoom<=o-_)return;const{context:d}=t;d.setStencilTestEnabled(!1),d.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,s,r)}_drawWithBrush(e,t,s){if(!this._brushCache.has(s)){const a=Ce[s];this._brushCache.set(s,new a)}this._brushCache.get(s).drawMany(e,[t])}}let c=class extends ye(pe(fe)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=E("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new Z("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:n,spatialReference:e,state:t,viewingMode:s}=this.view,a=s==="local"&&!K(e)||Q.force512VTL,l=this.layer.tileInfo.spatialReference.isGeographic,i=a?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,l?1:2),r=this._getTileInfoSupportError(i,this.layer.fullExtent);if(r!=null)return this.addResolvingPromise(Promise.reject(r));const o=J(()=>{var h,u;return(u=(h=this.view)==null?void 0:h.basemapTerrain)==null?void 0:u.tilingSchemeLocked}).then(()=>{var w,v,$;const h=n.tilingScheme,u=h.pixelSize,R=u===256?1:2,y=(w=n.spatialReference)!=null&&w.isGeographic&&u===256?1:0,C=(v=n.spatialReference)!=null&&v.isGeographic||u!==256?0:1;let f;if(this.schemaHelper=new _e(R,y,this.levelShift+C),u===256){const N=this.layer.tileInfo.spatialReference.isGeographic;f=this.layer.tileInfo.getOrCreateCompatible(256,N?1:2)}else f=($=this.view.spatialReference)!=null&&$.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const S=this._getTileInfoCompatibilityError(f,h);if(S)throw S;this.tileInfo=f});this._tileHandlerController=new AbortController;const d=this.view.resourceController;this._memCache=d.memoryController.newCache(`vtl-${this.layer.uid}`,h=>{h.release()}),this.addHandles(X(()=>this.view.qualitySettings.memoryLimit,h=>this._memCache.maxSize=Math.ceil(h/10*1048576),ee));const k=new P(this.layer.currentStyleInfo.style);this._tileHandler=new D(this.layer,k,t.contentPixelRatio,this._memCache);const T=this._tileHandlerController.signal,x=Se(d),I=this._tileHandler.start({signal:T,schedule:x}),M=this._tileHandler.spriteMosaic;M.then(h=>{!te(T)&&this._tileHandler&&(this.painter=new B(h,this._tileHandler.glyphMosaic))}),I.then(()=>this._tileHandlerController=null),this._updatingHandles.add(()=>{var h;return{style:this.layer.currentStyleInfo.style,pixelRatio:(h=this.view.state)==null?void 0:h.contentPixelRatio}},({style:h,pixelRatio:u})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const R=new P(h),y=new D(this.layer,R,u,this._memCache),C=y.start({signal:this._tileHandlerController.signal,schedule:x}),f=y.spriteMosaic;C.then(()=>this._tileHandlerController=null),this._updatingHandles.addPromise(Promise.all([C,f]).then(([,S])=>{const w=this._tileHandler,v=this.painter;this.painter=new B(S,y.glyphMosaic),this._tileHandler=y,this.emit("data-changed"),w.destroy(),v&&v.dispose()}))});const q=Promise.all([o,I,M]);this.addResolvingPromise(q)}destroy(){this.painter=O(this.painter),this._tileHandlerController=ie(this._tileHandlerController),this._tileHandler=H(this._tileHandler),this._memCache=H(this._memCache)}get contentZoom(){return E("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const n=this.tileInfo.lods,e=this.layer.minScale||n[0].scale,t=this.layer.maxScale||n[n.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){const n=this.tileInfo.lods;return{minScale:n[0].scale,maxScale:n[n.length-1].scale}}get dataLevelRange(){const{minScale:n,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(n,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}async fetchTile(n,e,t,s){return this._tileHandler.getVectorTile(n,e,t,s)}};g([m()],c.prototype,"layer",void 0),g([m()],c.prototype,"levelShift",void 0),g([m()],c.prototype,"contentZoom",null),g([m()],c.prototype,"displayLevelRange",null),g([m()],c.prototype,"tileInfo",void 0),g([m()],c.prototype,"dataScaleRange",null),g([m()],c.prototype,"dataLevelRange",null),g([m()],c.prototype,"updatingProgressValue",void 0),c=g([se("esri.views.3d.layers.VectorTileLayerView3D")],c);const ze=c;function Se(n){return e=>n.immediate.schedule(e)}export{ze as default};
