import{bY as b,m9 as g,gR as R,ma as M,bZ as f,b2 as m,aA as w}from"./index-383689b1.js";import{s as U,C as $,b as D}from"./Rasterizer-24c526d2.js";import{o as _}from"./imageutils-f0111c68.js";async function F(r,i){const n=U(r);if(n instanceof Error)throw n;await n.createImages(),b(i);const{frames:t,width:a,height:s}=n,c=document.createElement("canvas");c.width=a,c.height=s;const o=c.getContext("2d",{willReadFrequently:!0}),d=[],l=[];for(const e of t){l.push(g(e.delay||100));const p=e.imageElement;e.blendOp===0?o.globalCompositeOperation="copy":o.globalCompositeOperation="source-over";const h=e.disposeOp===2?o.getImageData(e.left,e.top,e.width,e.height):void 0;o.drawImage(p,e.left,e.top);const u=o.getImageData(0,0,a,s);d.push(u),e.disposeOp===0||(e.disposeOp===1?o.clearRect(e.left,e.top,e.width,e.height):e.disposeOp===2&&o.putImageData(h,e.left,e.top))}return{frameDurations:l,getFrame:e=>d[e],width:a,height:s}}const I=[137,80,78,71,13,10,26,10];function O(r){const i=new Uint8Array(r);return!I.some((n,t)=>n!==i[t])}function T(r){if(!O(r))return!1;const i=new DataView(r),n=new Uint8Array(r);let t,a=8;do{const s=i.getUint32(a);if(t=String.fromCharCode.apply(String,Array.prototype.slice.call(n.subarray(a+4,a+8))),t==="acTL")return!0;a+=12+s}while(t!=="IEND"&&a<n.length);return!1}async function v(r,i){const n=$(r),t=D(n,!0),{width:a,height:s}=n.lsd,c=document.createElement("canvas");c.width=a,c.height=s;const o=c.getContext("2d",{willReadFrequently:!0}),d=[],l=[];for(const e of t){l.push(g(e.delay||100));const p=new ImageData(e.patch,e.dims.width,e.dims.height),h=_(p),u=e.disposalType===3?o.getImageData(e.dims.left,e.dims.top,e.dims.width,e.dims.height):void 0;o.drawImage(h,e.dims.left,e.dims.top);const y=o.getImageData(0,0,a,s);d.push(y),e.disposalType===1||(e.disposalType===2?o.clearRect(e.dims.left,e.dims.top,e.dims.width,e.dims.height):e.disposalType===3&&o.putImageData(u,e.dims.left,e.dims.top))}return{frameDurations:l,getFrame:e=>d[e],width:a,height:s}}const C=[71,73,70];function k(r){const i=new Uint8Array(r);return!C.some((n,t)=>n!==i[t])}function E(r){if(!k(r))return!1;const i=new DataView(r),n=i.getUint8(10);let t=13+(128&n?3*2**(1+(7&n)):0),a=0,s=!1;for(;!s;){switch(i.getUint8(t++)){case 33:if(!c())return!1;break;case 44:o();break;case 59:s=!0;break;default:return!1}if(a>1)return!0}function c(){switch(i.getUint8(t++)){case 249:d();break;case 1:l();break;case 254:e();break;case 255:p();break;default:return!1}return!0}function o(){a++,t+=8;const u=i.getUint8(t++);t+=128&u?3*2**(1+(7&u)):0,t++,h()}function d(){t++,t+=4,h()}function l(){a++,t++,t+=12,h()}function e(){h()}function p(){t++,t+=8,t+=3,h()}function h(){let u;for(;u=i.getUint8(t++);)t+=u}return!1}class S{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(i){return this._resourceMap.get(i)??null}async fetchResource(i,n){const t=this._resourceMap.get(i);if(t)return{width:t.width,height:t.height};let a=this._inFlightResourceMap.get(i);return a?a.then(s=>({width:s.width,height:s.height})):(a=A(i,n),this._inFlightResourceMap.set(i,a),a.then(s=>(this._inFlightResourceMap.delete(i),this._resourceMap.set(i,s),{width:s.width,height:s.height}),()=>({width:0,height:0})))}deleteResource(i){this._inFlightResourceMap.delete(i),this._resourceMap.delete(i)}loadFont(i){return R(i)}}async function x(r,i){const n=window.URL.createObjectURL(r);try{const{data:t}=await f(n,{...i,responseType:"image"});return t}catch(t){throw m(t)?t:new w("mapview-invalid-resource",`Could not fetch requested resource at ${n}`)}finally{window.URL.revokeObjectURL(n)}}async function A(r,i){const{arrayBuffer:n,mediaType:t}=await L(r,i),a=t==="image/png";return t==="image/gif"&&E(n)?v(n):a&&T(n)?F(n,i):x(new Blob([n],{type:t}),i)}async function L(r,i){let n;const t=";base64,";if(r.includes(t)){const a=r.indexOf(t),s=r.indexOf(t)+t.length,c=r.substring(s);n={arrayBuffer:M(c),mediaType:r.substring(0,a).replace("data:","")}}else try{const a=await f(r,{responseType:"array-buffer",...i});n={arrayBuffer:a.data,mediaType:a.getHeader("Content-Type")}}catch(a){if(!m(a))throw new w("mapview-invalid-resource",`Could not fetch requested resource at ${r}`)}return n}export{S as h};
